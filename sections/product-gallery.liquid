{%- if section.settings.enable_quick_add -%}
  <link rel="stylesheet" href="{{ 'quick-add.css' | asset_url }}" media="print" onload="this.media='all'">
  <script src="{{ 'quick-add.js' | asset_url }}" defer="defer"></script>
{%- endif -%}

{%- style -%}
  .product-gallery-{{ section.id }} {
    --columns-desktop: {{ section.settings.columns_per_row }};
    --columns-mobile: {{ section.settings.mobile_columns }};
    --gap-size: {{ section.settings.gap_size }}px;
  }

  .product-gallery-{{ section.id }} .product-gallery__grid {
    display: grid;
    grid-template-columns: repeat(var(--columns-mobile), 1fr);
    gap: 1px;
  }

  @media screen and (min-width: 750px) {
    .product-gallery-{{ section.id }} .product-gallery__grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media screen and (min-width: 990px) {
    .product-gallery-{{ section.id }} .product-gallery__grid {
      grid-template-columns: repeat(var(--columns-desktop), 1fr);
    }
  }

  .product-gallery-{{ section.id }} .product-gallery__card {
    position: relative;
    overflow: hidden;
    background-color: rgb(var(--color-background));
  }

  .product-gallery-{{ section.id }} .product-gallery__image-wrapper {
    position: relative;
    width: 100%;
    padding-bottom: 130%;
    overflow: hidden;
  }

  .product-gallery-{{ section.id }} .product-gallery__image-wrapper img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .product-gallery-{{ section.id }} .product-gallery__card:hover .product-gallery__image-wrapper img {
    transform: scale(1.05);
  }

  .product-gallery-{{ section.id }} .product-gallery__overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 2;
  }

  .product-gallery-{{ section.id }} .product-gallery__card:hover .product-gallery__overlay {
    opacity: 1;
  }

  .product-gallery-{{ section.id }} .product-gallery__icon-button {
    width: 4.5rem;
    height: 4.5rem;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.9);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.2s ease, background-color 0.2s ease;
    color: rgb(var(--color-foreground));
  }

  .product-gallery-{{ section.id }} .product-gallery__icon-button:hover {
    transform: scale(1.1);
    background-color: rgba(255, 255, 255, 1);
  }

  .product-gallery-{{ section.id }} .product-gallery__icon-button .icon {
    width: 2rem;
    height: 2rem;
    color: #000000;
  }

  .product-gallery-{{ section.id }} .product-gallery__icon-button {
    position: relative;
  }

  .product-gallery-{{ section.id }} .product-gallery__icon-button .loading-overlay__spinner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  .product-gallery-{{ section.id }} .product-gallery__icon-button.loading .icon {
    opacity: 0;
  }

  .product-gallery-{{ section.id }} .product-gallery__icon-button.loading .loading-overlay__spinner {
    display: block;
  }

  .product-gallery-{{ section.id }} .product-gallery__icon-button .loading-overlay__spinner.hidden {
    display: none;
  }

  .product-gallery-{{ section.id }} .product-gallery__icon-button .spinner {
    width: 1.5rem;
    height: 1.5rem;
  }

  .product-gallery-{{ section.id }} .product-gallery__info {
    padding: 1rem;
  }

  .product-gallery-{{ section.id }} .product-gallery__header {
    text-align: {{ section.settings.text_alignment }};
    margin-bottom: 2rem;
  }

  .product-gallery-{{ section.id }} .product-gallery__description {
    margin-top: 0.5rem;
    font-size: 1rem;
    line-height: 1.5;
    color: rgb(var(--color-foreground));
    opacity: 0.8;
  }

  .product-gallery-{{ section.id }} .full-width {
    width: 100%;
    max-width: 100%;
    padding-left: 0;
    padding-right: 0;
  }

  @media screen and (min-width: 750px) {
    .product-gallery-{{ section.id }} .full-width {
      padding-left: 0;
      padding-right: 0;
    }
  }

  .product-gallery-{{ section.id }} .product-gallery__title {
    margin: 0 0 0.5rem 0;
    font-size: 1rem;
    font-weight: 500;
    line-height: 1.4;
    color: rgb(var(--color-foreground));
  }

  .product-gallery-{{ section.id }} .product-gallery__title a {
    color: inherit;
    text-decoration: none;
  }

  .product-gallery-{{ section.id }} .product-gallery__title a:hover {
    text-decoration: underline;
  }

  .product-gallery-{{ section.id }} .product-gallery__price {
    font-size: 0.875rem;
    color: rgb(var(--color-foreground));
    opacity: 0.8;
  }

  /* .product-gallery-{{ section.id }} .product-gallery__price .price,
  .product-gallery-{{ section.id }} .product-gallery__price .price-item {
    color: #ffffff;
  } */

  @media screen and (max-width: 749px) {
    .product-gallery-{{ section.id }} .product-gallery__overlay {
      opacity: 1;
      background-color: rgba(0, 0, 0, 0.2);
    }

    .product-gallery-{{ section.id }} .product-gallery__icon-button {
      width: 3rem;
      height: 3rem;
    }

    .product-gallery-{{ section.id }} .product-gallery__icon-button .icon {
      width: 1.25rem;
      height: 1.25rem;
    }
  }

  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }

  .color-scheme-{{ section.id }}.color-custom {
    --color-background: {{ section.settings.custom_colors_background.red }}, {{ section.settings.custom_colors_background.green }}, {{ section.settings.custom_colors_background.blue }};
    --gradient-background: {% if section.settings.custom_gradient_background != blank %}{{ section.settings.custom_gradient_background }}{% else %}{{ section.settings.custom_colors_background }}{% endif %};
    {% if section.settings.custom_image_background != blank %}
      {% # theme-check-disable %}
      --gradient-background: url('{{ section.settings.custom_image_background | img_url: 'master' }}') center center / cover no-repeat;
      {% # theme-check-enable %}
    {% endif %}
    --color-foreground: {{ section.settings.custom_colors_text.red }}, {{ section.settings.custom_colors_text.green }}, {{ section.settings.custom_colors_text.blue }};
  }
{%- endstyle -%}

<div class="product-gallery-{{ section.id }} color-scheme-{{ section.id }} color-{{ section.settings.color_scheme }} gradient content-for-grouping animate-section animate--hidden isolate section-{{ section.id }}-padding">
  {% if section.settings.display_id %}
    <copy-button class='section-id-btn button' data-content="#shopify-section-{{ section.id }}" data-success="false">
      <span class="copy-text">Click to copy section ID</span>
      <span class="copy-success">ID copied successfully!</span>
    </copy-button>
  {% endif %}

  <div class="{% if section.settings.full_width %}full-width{% else %}page-width{% endif %}">
    {%- if section.settings.title != blank or section.settings.description != blank -%}
      <div class="product-gallery__header">
        {%- if section.settings.title != blank -%}
          <h2 class="title {{ section.settings.heading_size }} title-with-highlight animate-item animate-item--child index-0" style='--hightlight-color:{{ section.settings.title_highlight_color }}'>
            {{ section.settings.title }}
          </h2>
        {%- endif -%}
        {%- if section.settings.description != blank -%}
          <div class="product-gallery__description">
            {{ section.settings.description }}
          </div>
        {%- endif -%}
      </div>
    {%- endif -%}

    {%- if section.blocks.size > 0 -%}
      <div class="product-gallery__grid">
        {%- for block in section.blocks -%}
          {%- assign product = block.settings.product -%}
          {%- if product != blank -%}
            <div class="product-gallery__card" {{ block.shopify_attributes }}>
              <div class="product-gallery__image-wrapper">
                {%- if product.featured_media -%}
                  {%- liquid
                    assign widths = '375, 550, 750, 1100, 1500, 1780, 2000, 3000, 3840'
                    assign image_height = product.featured_media.width | divided_by: product.featured_media.aspect_ratio
                  -%}
                  {{
                    product.featured_media
                    | image_url: width: 3840
                    | image_tag:
                      loading: 'lazy',
                      height: image_height,
                      sizes: '(min-width: 990px) calc((100vw - 130px) / var(--columns-desktop)), (min-width: 750px) calc((100vw - 120px) / 2), calc((100vw - 35px) / var(--columns-mobile))',
                      widths: widths,
                      alt: product.featured_media.alt | default: product.title | escape
                  }}
                {%- else -%}
                  {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg placeholder' }}
                {%- endif -%}

                <div class="product-gallery__overlay">
                  <a
                    href="{{ product.url }}"
                    class="product-gallery__icon-button"
                          aria-label="View product: {{ product.title | escape }}"
                  >
                    {% render 'icon-eye' %}
                  </a>

                  {%- if section.settings.enable_quick_add -%}
                    {%- liquid
                      assign product_form_id = 'quick-add-' | append: section.id | append: '-' | append: product.id
                      assign qty_rules = false
                      if product.selected_or_first_available_variant.quantity_rule.min > 1 or product.selected_or_first_available_variant.quantity_rule.max != null or product.selected_or_first_available_variant.quantity_rule.increment > 1
                        assign qty_rules = true
                      endif
                      assign quick_add_valid_variants = false
                      if product.variants.size > 1
                        assign quick_add_valid_variants = true
                      endif
                      if product.options.size < 1
                        assign quick_add_valid_variants = false
                      endif
                    -%}
                    {%- if quick_add_valid_variants or qty_rules -%}
                      <modal-opener data-modal="#QuickAdd-{{ product.id }}">
                        <button
                          type="button"
                          class="product-gallery__icon-button"
                          aria-label="{{ 'products.product.add_to_cart' | t: product_name: product.title | escape }}"
                          data-product-url="{{ product.url }}"
                        >
                          {% render 'icon-cart' %}
                          <div class="loading-overlay__spinner hidden">
                            <svg
                              aria-hidden="true"
                              focusable="false"
                              class="spinner"
                              viewBox="0 0 66 66"
                              xmlns="http://www.w3.org/2000/svg"
                            >
                              <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
                            </svg>
                          </div>
                        </button>
                      </modal-opener>
                      <quick-add-modal id="QuickAdd-{{ product.id }}" class="quick-add-modal">
                        <div
                          role="dialog"
                          aria-label="{{ 'products.product.choose_product_options' | t: product_name: product.title | escape }}"
                          aria-modal="true"
                          class="quick-add-modal__content global-settings-popup"
                          tabindex="-1"
                        >
                          <button
                            id="ModalClose-{{ product.id }}"
                            type="button"
                            class="quick-add-modal__toggle"
                            aria-label="{{ 'accessibility.close' | t }}"
                          >
                            {% render 'icon-close' %}
                          </button>
                          <div id="QuickAddInfo-{{ product.id }}" class="quick-add-modal__content-info"></div>
                        </div>
                      </quick-add-modal>
                    {%- else -%}
                      <product-form id='product-form-{{ product_form_id }}'>
                        {%- form 'product',
                          product,
                          id: product_form_id,
                          class: 'form',
                          novalidate: 'novalidate',
                          data-type: 'add-to-cart-form'
                        -%}
                          <input
                            type="hidden"
                            name="id"
                            value="{{ product.selected_or_first_available_variant.id }}"
                            disabled
                          >
                          <button
                            type="submit"
                            name="add"
                            class="product-gallery__icon-button"
                            aria-label="{{ 'products.product.add_to_cart' | t: product_name: product.title | escape }}"
                            aria-live="polite"
                            data-sold-out-message="true"
                            {% if product.selected_or_first_available_variant.available == false %}
                              disabled
                            {% endif %}
                          >
                            {% render 'icon-cart' %}
                          </button>
                        {%- endform -%}
                      </product-form>
                    {%- endif -%}
                  {%- endif -%}
                </div>
              </div>

              <div class="product-gallery__info">
                <h3 class="product-gallery__title">
                  <a href="{{ product.url }}">
                    {{ product.title | escape }}
                  </a>
                </h3>
                <div class="product-gallery__price">
                  {% render 'price', product: product, price_class: '', use_variant: true, show_badges: false %}
                </div>
              </div>
            </div>
          {%- endif -%}
        {%- endfor -%}
      </div>
    {%- else -%}
      <div class="product-gallery__empty">
        <p>No products added yet. Add products using the section settings.</p>
      </div>
    {%- endif -%}
  </div>
</div>

{% schema %}
{
  "name": "Product Gallery",
  "tag": "section",
  "class": "section",
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "checkbox",
      "id": "display_id",
      "label": "Display section ID",
      "info": "ID is used in the Sections group section to merge 2 sections. ID can also be put inside any button link and the button will scroll to this section.",
      "default": false
    },
    {
      "type": "inline_richtext",
      "id": "title",
      "label": "Heading",
      "default": "Product Gallery"
    },
    {
      "type": "richtext",
      "id": "description",
      "label": "Description",
      "info": "Mô tả về section này"
    },
    {
      "type": "color",
      "id": "title_highlight_color",
      "label": "Heading highlight color",
      "default": "#6D388B"
    },
    {
      "type": "select",
      "id": "heading_size",
      "options": [
        {
          "value": "h2",
          "label": "Small"
        },
        {
          "value": "h1",
          "label": "Medium"
        },
        {
          "value": "h0",
          "label": "Large"
        }
      ],
      "default": "h1",
      "label": "Heading size"
    },
    {
      "type": "select",
      "id": "text_alignment",
      "label": "Text alignment",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "center",
      "info": "Vị trí của title và description"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Full width",
      "default": false,
      "info": "Hiển thị section full width thay vì page width"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "columns_per_row",
      "label": "Số sản phẩm trên 1 hàng (Desktop)",
      "min": 2,
      "max": 6,
      "step": 1,
      "default": 4,
      "info": "Số cột hiển thị trên màn hình desktop (từ 990px trở lên)"
    },
    {
      "type": "select",
      "id": "mobile_columns",
      "label": "Số sản phẩm trên 1 hàng (Mobile)",
      "options": [
        {
          "value": "1",
          "label": "1 cột"
        },
        {
          "value": "2",
          "label": "2 cột"
        }
      ],
      "default": "1",
      "info": "Số cột hiển thị trên màn hình mobile (dưới 750px)"
    },
    {
      "type": "range",
      "id": "gap_size",
      "label": "Khoảng cách giữa các sản phẩm",
      "min": 10,
      "max": 50,
      "step": 5,
      "unit": "px",
      "default": 20
    },
    {
      "type": "checkbox",
      "id": "enable_quick_add",
      "label": "Enable quick add",
      "default": true,
      "info": "Cho phép thêm sản phẩm vào giỏ hàng trực tiếp từ gallery"
    },
    {
      "type": "header",
      "content": "Color scheme"
    },
    {
      "type": "select",
      "id": "color_scheme",
      "options": [
        {
          "value": "accent-1",
          "label": "Accent 1"
        },
        {
          "value": "accent-2",
          "label": "Accent 2"
        },
        {
          "value": "background-1",
          "label": "Background 1"
        },
        {
          "value": "background-2",
          "label": "Background 2"
        },
        {
          "value": "inverse",
          "label": "Inverse"
        },
        {
          "value": "custom",
          "label": "Custom"
        }
      ],
      "default": "background-1",
      "label": "Color scheme",
      "info": "Custom color scheme is edited at the bottom of section settings."
    },
    {
      "type": "select",
      "id": "visibility",
      "options": [
        {
          "value": "desktop-hidden",
          "label": "Mobile only"
        },
        {
          "value": "mobile-hidden",
          "label": "Desktop only"
        },
        {
          "value": "always-display",
          "label": "All devices"
        }
      ],
      "label": "Display on",
      "default": "always-display"
    },
    {
      "type": "header",
      "content": "t:sections.all.padding.section_padding_heading"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_bottom",
      "default": 36
    },
    {
      "type": "header",
      "content": "Custom color scheme",
      "info": "Applied if Color scheme setting is set to Custom."
    },
    {
      "type": "color",
      "id": "custom_colors_background",
      "default": "#FFFFFF",
      "label": "Background color"
    },
    {
      "type": "color_background",
      "id": "custom_gradient_background",
      "label": "Gradient background",
      "info": "If added, replaces Background color when applicable."
    },
    {
      "type": "image_picker",
      "id": "custom_image_background",
      "label": "Image background"
    },
    {
      "type": "color",
      "id": "custom_colors_text",
      "default": "#2E2A39",
      "label": "Text"
    }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Product",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Product Gallery",
      "blocks": [
        {
          "type": "product"
        },
        {
          "type": "product"
        },
        {
          "type": "product"
        },
        {
          "type": "product"
        }
      ]
    }
  ]
}
{% endschema %}

